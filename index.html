<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f766e" />
    <title>Attendance v2</title>
    <!-- Manifest will be attached dynamically in secure contexts -->
    <link rel="icon" href="assets/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="assets/icon-192.png" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="sidebar.css" />

    <!-- Lightweight libs (cached by SW for offline) -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

    <!-- App entrypoint (ES modules) -->
    <script type="module" src="src/main.js"></script>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="app-header" role="banner">
      <div class="brand">
        <h1 id="app-title">Attendance</h1>
        <p class="brand-tagline">Daily attendance in one place</p>
      </div>
      <nav class="app-nav" aria-label="Primary">
        <button data-route="#/take" class="nav-btn" aria-current="true">Check In</button>
        <button data-route="#/roster" class="nav-btn">Roster</button>
        <button data-route="#/calendar" class="nav-btn">Calendar</button>
        <button data-route="#/trends" class="nav-btn">Trends</button>
        <button data-route="#/insights" class="nav-btn">Insights</button>
        <button data-route="#/help" class="nav-btn">Help</button>
        <button data-route="#/settings" class="nav-btn">Settings</button>
      </nav>
      <div id="offline-badge" class="offline-badge" hidden title="Offline">Offline</div>
    </header>

    <main id="main" tabindex="-1">
      <!-- Take Attendance -->
      <section id="view-take" data-view="take" class="view" data-tone="teal">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Check In</h2>
            <p class="view-description">Log attendance and capture notes without leaving the roster.</p>
          </div>
          <div class="view-actions">
            <button id="save-attendance" type="button" class="primary-action">Save attendance</button>
            <button id="print-attendance" type="button" class="secondary-action">Print</button>
          </div>
        </header>
        <div class="view-shell take-layout">
          <aside id="sidebar" class="take-sidebar" aria-label="Session basics and navigation">
            <div class="take-sidebar__sticky">
              <h2 class="sr-only">Session basics and navigation</h2>
            </div>
            <div id="sidebar-scroll" class="take-sidebar__scroll" role="group" aria-label="Sidebar controls">
              <section class="section-card" data-section="session-basics">
                <div class="section-card__surface">
                  <header class="section-card__header">
                    <h3 class="section-card__title">Session basics</h3>
                  </header>
                  <div class="section-card__body">
                    <label class="sidebar-field">
                      <span class="sidebar-field__label">Date</span>
                      <div class="sidebar-date">
                        <div class="date-nav" role="group" aria-label="Change day">
                          <button id="take-date-prev" type="button" class="chip-control" title="Previous day" aria-label="Previous day">←</button>
                          <button id="take-date-today" type="button" class="chip-control" title="Jump to today">Today</button>
                          <button id="take-date-next" type="button" class="chip-control" title="Next day" aria-label="Next day">→</button>
                        </div>
                        <div class="sidebar-date__input">
                          <input type="date" id="take-date" aria-describedby="date-helper" />
                          <span id="date-helper" class="sidebar-hint" aria-live="polite"></span>
                        </div>
                      </div>
                    </label>
                    <label class="sidebar-field">
                      <span class="sidebar-field__label">Session</span>
                      <select id="take-event"></select>
                    </label>
                    <div class="event-stepper" role="tablist" aria-label="Session flow" id="event-stepper"></div>
                    <p class="event-stepper-note">Office check-ins are required. Morning and Afternoon meetings are supplemental and carry no penalty if left blank.</p>
                  </div>
                </div>
              </section>

              <section class="section-card" data-section="find-people">
                <div class="section-card__surface">
                  <header class="section-card__header">
                    <h3 class="section-card__title">Find people</h3>
                  </header>
                  <div class="section-card__body">
                    <label class="sidebar-field">
                      <span class="sidebar-field__label">Search</span>
                      <input id="take-search" placeholder="Search people" />
                    </label>
                    <label class="sidebar-field sidebar-field--toggle">
                      <input type="checkbox" id="take-show-all" />
                      <span>Show all missionaries</span>
                    </label>
                  </div>
                </div>
              </section>

              <section class="section-card" data-section="bulk-actions">
                <div class="section-card__surface">
                  <header class="section-card__header">
                    <h3 class="section-card__title">Bulk actions</h3>
                  </header>
                  <div class="section-card__body">
                    <details class="sidebar-accordion">
                      <summary class="sidebar-accordion__summary">Open tools</summary>
                      <div class="sidebar-accordion__body">
                        <button id="mark-all-present" type="button">Mark all present</button>
                        <button id="clear-all" type="button" class="secondary-action">Clear all</button>
                      </div>
                    </details>
                  </div>
                </div>
              </section>

              <section class="section-card" data-section="navigator">
                <div class="section-card__surface">
                  <header class="section-card__header">
                    <h3 class="section-card__title">Navigator</h3>
                  </header>
                  <div class="section-card__body section-card__body--stack">
                    <div id="navigator-board" class="navigator-board" hidden>
                      <header class="navigator-board__header">
                        <div>
                          <span class="navigator-board__title">Office follow-up</span>
                          <p class="navigator-board__hint">Office is required. Morning and Afternoon meetings remain optional.</p>
                        </div>
                        <span id="navigator-count" class="navigator-board__count"></span>
                      </header>
                      <div id="take-tracking-stats" class="navigator-stats" hidden></div>
                      <div id="navigator-groups" class="navigator-groups" role="list"></div>
                    </div>
                    <div id="take-hidden-info" class="sidebar-notice" hidden>
                      <div class="sidebar-notice__body">
                        <strong id="take-hidden-count">0</strong>
                        <span>hidden for this day</span>
                      </div>
                      <div class="sidebar-notice__actions">
                        <button id="take-hidden-toggle" type="button">Show all</button>
                        <button id="take-hidden-hide" type="button" class="secondary-action">Hide</button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </aside>
          <div class="view-panel take-roster primary-panel" aria-live="polite">
            <div id="take-summary" class="take-summary" aria-live="polite" aria-atomic="true">
              <p class="summary-empty">Select a date and session to start.</p>
            </div>
            <ul id="people-list" class="people-list" aria-label="People list"></ul>
          </div>
        </div>
      </section>

      <!-- Roster -->
      <section id="view-roster" data-view="roster" class="view" hidden data-tone="cyan">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Roster</h2>
            <p class="view-description">Keep availability, tags, and mission status current.</p>
          </div>
          <div class="view-actions">
            <button id="add-person-btn" type="button" class="primary-action">Add missionary</button>
            <button id="bulk-paste-btn" type="button" class="secondary-action">Bulk paste</button>
            <input id="bulk-paste-input" type="file" accept=".txt,.csv" hidden />
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <div class="table-wrapper">
              <table class="roster-table">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Status</th>
                    <th scope="col">Tags</th>
                    <th scope="col">Mon</th>
                    <th scope="col">Tue</th>
                    <th scope="col">Wed</th>
                    <th scope="col">Thu</th>
                    <th scope="col">Fri</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody id="roster-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Insights -->
      <section id="view-insights" data-view="insights" class="view" hidden data-tone="indigo">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Insights</h2>
            <p class="view-description">Compare attendance across any range to see what is working.</p>
          </div>
          <div class="view-actions">
            <button id="analytics-run" type="button" class="primary-action">Run report</button>
            <button id="analytics-export-csv" type="button" class="secondary-action">Export CSV</button>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <form class="controls" onsubmit="return false;">
              <div class="control-section">
                <h3 class="section-label">Timeframe</h3>
                <div class="field-grid">
                  <label class="field"> <span class="field-label">From</span> <input type="date" id="analytics-from" /> </label>
                  <label class="field"> <span class="field-label">To</span> <input type="date" id="analytics-to" /> </label>
                  <label class="field"> <span class="field-label">Event</span> <select id="analytics-event"></select> </label>
                </div>
              </div>
              <details class="control-advanced">
                <summary>Advanced options</summary>
                <div class="control-advanced-body">
                  <label class="field field-toggle"><input type="checkbox" id="analytics-apply-event-weight" /> <span>Apply event weighting</span></label>
                  <label class="field field-toggle"><input type="checkbox" id="analytics-smooth-rate" /> <span>Smooth rate (7-day)</span></label>
                  <label class="field field-toggle"><input type="checkbox" id="analytics-active-only" /> <span>Active only</span></label>
                  <label class="field"> <span class="field-label">Tag</span> <input id="analytics-tag" placeholder="Filter by tag" /> </label>
                  <div class="button-group">
                    <span class="field-label">Quick ranges</span>
                    <div class="button-row">
                      <button id="analytics-range-14" type="button" class="secondary-action">Last 14</button>
                      <button id="analytics-range-30" type="button" class="secondary-action">Last 30</button>
                      <button id="analytics-range-90" type="button" class="secondary-action">Last 90</button>
                    </div>
                  </div>
                  <label class="field field-toggle"><input type="checkbox" id="analytics-compare" /> <span>Compare previous period</span></label>
                </div>
              </details>
            </form>
            <div id="analytics-summary" class="trends-summary"></div>
            <div class="cards one-line">
              <div class="card inline-stats">
                <div><span>Total present</span><strong id="totals-present">0</strong></div>
                <div><span>Total online</span><strong id="totals-online">0</strong></div>
                <div><span>Total excused</span><strong id="totals-excused">0</strong></div>
                <div><span>Total tardy</span><strong id="totals-tardy">0</strong></div>
                <div><span>Total absent</span><strong id="totals-absent">0</strong></div>
                <div><span>Avg score</span><strong id="totals-rate">0%</strong></div>
              </div>
            </div>
            <section class="chart-section">
              <h3 class="section-title">Trend</h3>
              <div class="mini-controls">
                <label class="field-toggle"><input type="checkbox" id="analytics-show-present" checked /> <span>Present</span></label>
                <label class="field-toggle"><input type="checkbox" id="analytics-show-online" checked /> <span>Online</span></label>
                <label class="field-toggle"><input type="checkbox" id="analytics-show-excused" checked /> <span>Excused</span></label>
                <label class="field-toggle"><input type="checkbox" id="analytics-show-tardy" checked /> <span>Tardy</span></label>
                <label class="field-toggle"><input type="checkbox" id="analytics-show-absent" checked /> <span>Absent</span></label>
                <label class="field-toggle"><input type="checkbox" id="analytics-show-rate" checked /> <span>Rate</span></label>
              </div>
              <canvas id="trend-chart" height="120"></canvas>
            </section>
            <section class="heatmap-section">
              <h3 class="section-title">Day of week</h3>
              <div id="dow-heatmap" class="heatmap" role="grid" aria-label="Attendance by day of week"></div>
            </section>
            <section class="analytics-days">
              <h3 class="section-title">Daily breakdown</h3>
              <div id="analytics-days" class="cards"></div>
            </section>
          </div>
        </div>
      </section>

      <!-- Trends -->
      <section id="view-trends" data-view="trends" class="view" hidden data-tone="violet">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Trends</h2>
            <p class="view-description">Compare people over time to celebrate momentum and coach gaps.</p>
          </div>
          <div class="view-actions">
            <button id="trends-run" type="button" class="primary-action">Run trends</button>
            <button id="trends-export-csv" type="button" class="secondary-action">Export CSV</button>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <form class="controls" onsubmit="return false;">
              <div class="control-section">
                <h3 class="section-label">People filters</h3>
                <div class="field-grid">
                  <label class="field"> <span class="field-label">From</span> <input type="date" id="trends-from" /> </label>
                  <label class="field"> <span class="field-label">To</span> <input type="date" id="trends-to" /> </label>
                  <label class="field"> <span class="field-label">Event</span> <select id="trends-event"></select> </label>
                  <label class="field"> <span class="field-label">Sort</span>
                    <select id="trends-sort">
                      <option value="avg_desc">Best (Avg)</option>
                      <option value="avg_asc">Worst (Avg)</option>
                      <option value="tardy_desc">Most Tardies</option>
                      <option value="tardy_asc">Least Tardies</option>
                      <option value="name_asc">Name (A–Z)</option>
                      <option value="name_desc">Name (Z–A)</option>
                      <option value="sessions_desc">Most Sessions</option>
                      <option value="sessions_asc">Least Sessions</option>
                    </select>
                  </label>
                </div>
              </div>
              <details class="control-advanced">
                <summary>Advanced filters</summary>
                <div class="control-advanced-body">
                  <label class="field field-toggle"><input type="checkbox" id="trends-apply-event-weight" /> <span>Apply event weighting</span></label>
                  <label class="field field-toggle"><input type="checkbox" id="trends-active-only" /> <span>Active only</span></label>
                  <label class="field"> <span class="field-label">Tag</span> <input id="trends-tag" placeholder="Filter by tag" /> </label>
                  <div class="button-group">
                    <span class="field-label">Quick ranges</span>
                    <div class="button-row">
                      <button id="trends-range-14" type="button" class="secondary-action">Last 14</button>
                      <button id="trends-range-30" type="button" class="secondary-action">Last 30</button>
                      <button id="trends-range-90" type="button" class="secondary-action">Last 90</button>
                    </div>
                  </div>
                </div>
              </details>
              <details class="control-advanced">
                <summary>Group thresholds</summary>
                <div class="control-advanced-body thresholds-panel">
                  <label class="field"> <span class="field-label">Preset</span>
                    <select id="trends-thresh-preset">
                      <option value="standard">Standard (Low 75%, High 90%)</option>
                      <option value="balanced">Balanced (Low 70%, High 85%)</option>
                      <option value="strict">Strict (Low 80%, High 95%)</option>
                    </select>
                  </label>
                  <label class="field slider-field"> <span class="field-label">Low</span> <input id="trends-thresh-low" type="range" min="0.6" max="1" step="0.01" /> </label>
                  <label class="field slider-field"> <span class="field-label">High</span> <input id="trends-thresh-high" type="range" min="0.6" max="1" step="0.01" /> </label>
                  <span id="trends-thresh-readout" class="chip"></span>
                  <button id="trends-apply-thresholds" type="button" class="secondary-action">Apply to settings</button>
                </div>
              </details>
            </form>
            <div id="trends-summary" class="trends-summary"></div>
            <div id="trends-people" class="cards"></div>
            <div class="view-support">
              <button id="trends-load-more" type="button" class="secondary-action" hidden>Load more</button>
            </div>
            <div id="trends-status-dow"></div>
          </div>
        </div>
      </section>

      <!-- Person Details -->
      <section id="view-person" data-view="person" class="view" hidden data-tone="violet">
        <header class="view-header">
          <div class="view-headline">
            <h2 id="person-title" class="view-title">Missionary details</h2>
            <p class="view-description">Review a person’s cadence with the same filters as team views.</p>
          </div>
          <div class="view-actions">
            <button id="person-back-trends" type="button" class="secondary-action">Back to trends</button>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <form class="controls" onsubmit="return false;">
              <div class="control-section">
                <h3 class="section-label">Range</h3>
                <div class="field-grid">
                  <label class="field"> <span class="field-label">From</span> <input type="date" id="person-from" /> </label>
                  <label class="field"> <span class="field-label">To</span> <input type="date" id="person-to" /> </label>
                  <label class="field"> <span class="field-label">Event</span> <select id="person-event"></select> </label>
                </div>
              </div>
              <label class="field field-toggle"><input type="checkbox" id="person-apply-event-weight" /> <span>Apply event weighting</span></label>
            </form>
            <div id="person-summary" class="trends-summary"></div>
            <div class="cards two-up">
              <div class="card">
                <h3>Day patterns (missionary)</h3>
                <div id="person-dow-individual" class="heatmap" role="grid" aria-label="This missionary by day of week"></div>
              </div>
              <div class="card">
                <h3>Day patterns (team)</h3>
                <div id="person-dow-team" class="heatmap" role="grid" aria-label="All missionaries by day of week"></div>
              </div>
            </div>
            <section class="analytics-days">
              <h3 class="section-title">Daily breakdown</h3>
              <div id="person-days" class="cards"></div>
            </section>
          </div>
        </div>
      </section>

      <!-- Calendar -->
      <section id="view-calendar" data-view="calendar" class="view" hidden data-tone="blue">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Calendar</h2>
            <p class="view-description">Scan month cadence and jump straight to a day in check-in.</p>
          </div>
          <div class="view-actions">
            <button id="cal-today" type="button" class="primary-action">Today</button>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <form class="controls" onsubmit="return false;">
              <div class="control-section">
                <h3 class="section-label">Month view</h3>
                <div class="field-grid">
                  <label class="field">
                    <span class="field-label">Month</span>
                    <div class="field-inline">
                      <button id="cal-month-prev" type="button" title="Previous month" aria-label="Previous month">Prev</button>
                      <input type="month" id="cal-month" />
                      <button id="cal-month-next" type="button" title="Next month" aria-label="Next month">Next</button>
                    </div>
                  </label>
                  <label class="field"> <span class="field-label">Event</span> <select id="cal-event"></select> </label>
                </div>
              </div>
              <label class="field field-toggle"><input type="checkbox" id="cal-apply-event-weight" /> <span>Apply event weighting</span></label>
            </form>
            <div class="calendar">
              <div class="calendar-header" aria-hidden="true">
                <div class="cal-dow">Mon</div>
                <div class="cal-dow">Tue</div>
                <div class="cal-dow">Wed</div>
                <div class="cal-dow">Thu</div>
                <div class="cal-dow">Fri</div>
              </div>
              <div class="calendar-grid" id="calendar-grid" role="grid" aria-label="Monthly attendance calendar"></div>
            </div>
            <section class="calendar-weeks">
              <h3 class="section-title">Weekly summaries</h3>
              <div id="calendar-weeks" class="cards"></div>
            </section>
            <div id="calendar-detail" class="calendar-detail" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- Help -->
      <section id="view-help" data-view="help" class="view" hidden data-tone="slate">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Help Center</h2>
            <p class="view-description">Everything you need to run daily attendance with confidence.</p>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel help-panel">
            <div class="help-hero">
              <div class="help-hero-copy">
                <h3>Need a hand?</h3>
                <p>Attendance keeps everyone aligned when the core flow stays consistent. This guide walks through the workflows, shortcuts, and common edge cases.</p>
                <ul class="help-hero-points">
                  <li><strong>Office</strong> check-ins drive coverage. Morning and Afternoon meetings are supplemental.</li>
                  <li>Statuses and tardy minutes fuel analytics &mdash; blanks stay "Pending" until recorded.</li>
                  <li>Back up often from <span class="help-inline">Settings &gt; Download backup</span> and watch the offline badge.</li>
                </ul>
              </div>
              <div class="help-hero-visual" aria-hidden="true">
                <div class="help-hero-card">
                  <header>
                    <span class="help-tag">Office coverage</span>
                    <strong>92%</strong>
                  </header>
                  <p>Log everyone in Office to keep weekdays green.</p>
                  <div class="help-hero-stats">
                    <div>
                      <span>Present</span>
                      <strong>18</strong>
                    </div>
                    <div>
                      <span>Pending</span>
                      <strong>3</strong>
                    </div>
                    <div>
                      <span>Tardy</span>
                      <strong>2</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <nav class="help-toc" id="help-toc" aria-label="Help topics">
              <h3>Quick jump</h3>
              <ul>
                <li><button type="button" data-target="help-quick-start">Quick start</button></li>
                <li><button type="button" data-target="help-sessions">Sessions &amp; coverage</button></li>
                <li><button type="button" data-target="help-status">Status guide</button></li>
                <li><button type="button" data-target="help-tardy">Tardies &amp; notes</button></li>
                <li><button type="button" data-target="help-roster">Roster &amp; service days</button></li>
                <li><button type="button" data-target="help-trends">Trends &amp; analytics</button></li>
                <li><button type="button" data-target="help-calendar">Calendar &amp; blanks</button></li>
                <li><button type="button" data-target="help-data">Data &amp; offline</button></li>
                <li><button type="button" data-target="help-troubleshooting">Troubleshooting</button></li>
              </ul>
            </nav>

            <article id="help-quick-start" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Quick start: Taking attendance</h3>
                <p>Office sessions are required; supplemental meetings are bonus detail. Follow this sequence every day.</p>
              </header>
              <div class="help-section-body">
                <ol class="help-steps">
                  <li>Select the <strong>date</strong> and confirm the <strong>Office</strong> session is selected first. The app remembers the last Office day you touched.</li>
                  <li>Work down the roster. <strong>Pending</strong> rows show who still needs a status. Use <span class="help-inline">Mark all present</span> if everyone made it.</li>
                  <li>Capture <strong>tardy minutes</strong> when needed &mdash; the modal will pop up when you choose Tardy.</li>
                  <li>Optionally log Morning or Afternoon meetings. Leaving them blank never hurts coverage.</li>
                  <li>Hit <strong>Save attendance</strong> before you leave the page or print.</li>
                </ol>
              </div>
              <div class="help-visual-stack">
              <div class="help-stepper-demo" aria-hidden="true">
                <div class="step-btn step-btn--primary" role="presentation">
                  <span class="step-title">Office</span>
                  <span class="step-sub">Required</span>
                </div>
                <div class="step-btn step-btn--optional" role="presentation">
                  <span class="step-title">Morning Meeting</span>
                </div>
                <div class="step-btn step-btn--optional" role="presentation">
                  <span class="step-title">Afternoon Meeting</span>
                </div>
              </div>
                <div class="help-status-demo" aria-hidden="true">
                  <div class="pill present" data-checked="true"><span>Present</span><span class="pill-hint">On-site</span></div>
                  <div class="pill online"><span>Online</span><span class="pill-hint">Remote</span></div>
                  <div class="pill tardy"><span>Tardy</span><span class="pill-hint">Ask minutes</span></div>
                  <div class="pill excused"><span>Excused</span><span class="pill-hint">Pre-approved</span></div>
                  <div class="pill absent"><span>Absent</span><span class="pill-hint">Follow up</span></div>
                </div>
              </div>
              <div class="help-callout help-callout--tip">
                <strong>Tip:</strong> Turn on <span class="help-inline">Show all missionaries</span> in the sidebar when someone visits outside their usual service day.
              </div>
            </article>

            <article id="help-sessions" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Sessions &amp; coverage math</h3>
                <p>Only Office attendance affects coverage, blanks, and alerts. Supplemental meetings are pure bonus data.</p>
              </header>
              <div class="help-section-body">
                <ul>
                  <li><strong>Office required:</strong> Coverage stats, blank-day alerts, and analytics defaults all read Office sessions first.</li>
                  <li><strong>Supplemental meetings:</strong> Morning and Afternoon meetings never penalize you if left empty. Record them when you want deeper reporting.</li>
                  <li><strong>Event weights:</strong> Analytics and Trends can multiply scores by the event weight (Office = 1.0, meetings lighter). Toggle <span class="help-inline">Apply event weighting</span> to include or ignore those multipliers.</li>
                </ul>
              </div>
              <div class="help-callout help-callout--info">
                <strong>Office follow-up:</strong> The Navigator highlights weekdays where Office is incomplete. Click any entry to jump straight to that day.
              </div>
            </article>

            <article id="help-status" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Status guide &amp; scoring</h3>
                <p>Statuses drive analytics scoring. Pick the closest match instead of leaving blanks.</p>
              </header>
              <div class="help-section-body">
                <div class="help-status-grid">
                  <div>
                    <h4>Present</h4>
                    <p>Counted as 100% attendance. Use when the missionary is in the office on time.</p>
                  </div>
                  <div>
                    <h4>Online</h4>
                    <p>Remote participation. Worth 95% of a Present in analytics, highlighted teal.</p>
                  </div>
                  <div>
                    <h4>Tardy</h4>
                    <p>Triggers the minutes modal. Weighted at 75% and shows in tardy trend filters.</p>
                  </div>
                  <div>
                    <h4>Excused</h4>
                    <p>Approved absence (appointments, travel). Counts half credit for reporting.</p>
                  </div>
                  <div>
                    <h4>Absent</h4>
                    <p>No-show without context. Zero credit and appears in attention lists.</p>
                  </div>
                  <div>
                    <h4>Early leave</h4>
                    <p>Use <span class="help-inline">Left Early</span> or <span class="help-inline">Left Very Early</span> when someone departs mid-session.</p>
                  </div>
                </div>
              </div>
            </article>

            <article id="help-tardy" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Tardies, notes, and follow-up</h3>
              </header>
              <div class="help-section-body">
                <p>Recording tardies keeps analytics honest and surfaces patterns quickly.</p>
                <ul>
                  <li><strong>Minutes prompt:</strong> Selecting Tardy opens the modal. Enter minutes late, or cancel to keep the previous status.</li>
                  <li><strong>Thresholds:</strong> Adjust the global tardy threshold (default 5 minutes) in <span class="help-inline">Settings</span>. The prompt will always appear, but analytics flagging can reflect your threshold.</li>
                  <li><strong>Notes:</strong> Use the note bubble on each row for context. Saved notes show a solid outline so you can revisit them.</li>
                </ul>
              </div>
              <div class="help-callout help-callout--warning">
                <strong>Remember:</strong> Leaving someone Pending is worse than marking an Excused or Absent. Pending records drag progress down and signal missing information.
              </div>
            </article>

            <article id="help-roster" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Roster &amp; service days</h3>
              </header>
              <div class="help-section-body">
                <ul>
                  <li><strong>Service-day filters:</strong> The Take view hides missionaries who are not scheduled for the current weekday. Check <span class="help-inline">Show all missionaries</span> to override.</li>
                  <li><strong>Tags:</strong> Add comma-separated tags (districts, assignments) to enable analytics filters and quick search.</li>
                  <li><strong>Inactive records:</strong> Toggle <span class="help-inline">Deactivate</span> instead of deleting so history stays intact.</li>
                  <li><strong>Bulk updates:</strong> Use <span class="help-inline">Bulk paste</span> in Roster to paste from spreadsheets into the structured format.</li>
                </ul>
              </div>
            </article>

            <article id="help-trends" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Trends &amp; insights</h3>
                <p>Visualize consistency, compare groups, and highlight coaching opportunities.</p>
              </header>
              <div class="help-section-body">
                <ul>
                  <li><strong>Pins:</strong> Click the star on any trend card to pin a missionary to the top. Pins persist per device.</li>
                  <li><strong>Thresholds:</strong> Adjust low/high thresholds to change the green/yellow/red buckets. Use presets or custom sliders.</li>
                  <li><strong>Weighting:</strong> Turn on <span class="help-inline">Apply event weighting</span> when Morning/Afternoon meetings should influence scores.</li>
                  <li><strong>Sparkline insight:</strong> Each card shows the last ten weighted sessions. Sudden drops usually mean missed Office logs.</li>
                </ul>
              </div>
              <div class="help-trend-demo" aria-hidden="true">
                <article class="card trend-card rate-high help-trend-card">
                  <header class="trend-card__header">
                    <div class="trend-card__title">
                      <strong class="trend-card__name">Taylor Jordan</strong>
                      <div class="trend-card__tags">
                        <span class="trend-tag">District 3</span>
                        <span class="trend-tag">Trainer</span>
                      </div>
                    </div>
                    <div class="trend-card__score">
                      <span class="trend-card__rate">94%</span>
                    </div>
                  </header>
                  <div class="trend-card__meta">
                    <span>23 sessions</span>
                    <span>Last Mar 4</span>
                  </div>
                  <div class="trend-card__spark">
                    <svg class="sparkline" viewBox="0 0 120 36" preserveAspectRatio="none"><path d="M2,26 L26,14 L50,20 L74,10 L98,6 L118,12" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
                  </div>
                  <div class="trend-card__stats">
                    <div class="trend-card__stat"><span>Present</span><strong>18</strong></div>
                    <div class="trend-card__stat"><span>Online</span><strong>3</strong></div>
                    <div class="trend-card__stat"><span>Tardy</span><strong>1</strong></div>
                    <div class="trend-card__stat"><span>Excused</span><strong>2</strong></div>
                    <div class="trend-card__stat"><span>Absent</span><strong>0</strong></div>
                  </div>
                  <div class="trend-card__actions">
                    <span class="trend-card__btn is-static">Details</span>
                    <span class="trend-card__btn is-static">Profile</span>
                    <span class="trend-card__btn is-static">Open day</span>
                  </div>
                </article>
              </div>
            </article>

            <article id="help-calendar" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Calendar &amp; blank days</h3>
              </header>
              <div class="help-section-body">
                <ul>
                  <li><strong>Heatmaps:</strong> Hover over a day to view status counts and jump back to Take with <span class="help-inline">Open in Take</span>.</li>
                  <li><strong>Week summaries:</strong> Weekly cards show weighted averages. Gray cards usually mean Office data is missing.</li>
                  <li><strong>Navigator:</strong> In the Take sidebar, review the Office follow-up list to see which days are incomplete and jump directly to them.</li>
                </ul>
              </div>
              <div class="help-callout help-callout--tip">
                <strong>Pro move:</strong> Clear any filters before using <span class="help-inline">Open in Take</span> so the roster matches what you see in the calendar or trends card.
              </div>
            </article>

            <article id="help-data" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Data safety &amp; offline mode</h3>
              </header>
              <div class="help-section-body">
                <ul>
                  <li><strong>Backups:</strong> Download a JSON backup weekly from <span class="help-inline">Settings &gt; Download backup</span>. Store it somewhere safe.</li>
                  <li><strong>Restores:</strong> Use <span class="help-inline">Upload backup</span> for full restores or <span class="help-inline">Import from v1</span> to upgrade legacy data.</li>
                  <li><strong>Offline badge:</strong> The top-right badge turns on when your browser goes offline. You can still take attendance; save once you reconnect.</li>
                  <li><strong>Service worker:</strong> When served securely (https or localhost), the app installs offline assets automatically.</li>
                </ul>
              </div>
              <div class="help-callout help-callout--warning">
                <strong>Important:</strong> Clearing data from the Settings danger zone wipes everything, including backups stored locally. Download a fresh backup first.
              </div>
            </article>

            <article id="help-troubleshooting" class="help-section" tabindex="-1">
              <header class="help-section-header">
                <h3>Troubleshooting &amp; FAQ</h3>
              </header>
              <div class="help-section-body">
                <dl class="help-faq">
                  <dt>Why don&rsquo;t I see someone on the Take roster?</dt>
                  <dd>They may be inactive or not scheduled for that weekday. Check the Roster for service days and toggle <span class="help-inline">Show all missionaries</span>.</dd>
                  <dt>The coverage badge dropped after I recorded Morning Meeting. What happened?</dt>
                  <dd>Coverage only counts Office. If Morning Meeting is filled but Office isn&rsquo;t, coverage will still show a gap.</dd>
                  <dt>Analytics percentages look off.</dt>
                  <dd>Confirm <span class="help-inline">Apply event weighting</span> is set the way you expect and verify statuses (blanks score zero).</dd>
                  <dt>My pins disappeared after switching computers.</dt>
                  <dd>Pins are stored per browser. Pin again on any new device.</dd>
                  <dt>Need a clean slate?</dt>
                  <dd>Use <span class="help-inline">Download backup</span> first, then clear data from Settings. Re-import the backup to restore.</dd>
                </dl>
              </div>
              <div class="help-callout help-callout--info">
                <strong>Still stuck?</strong> Share the browser version, the page you&rsquo;re on, and any steps to reproduce the issue when you reach out for help.
              </div>
            </article>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="view-settings" data-view="settings" class="view" hidden data-tone="slate">
        <header class="view-header">
          <div class="view-headline">
            <h2 class="view-title">Settings</h2>
            <p class="view-description">Adjust defaults and keep a backup handy. Changes save instantly.</p>
          </div>
        </header>
        <div class="view-shell">
          <div class="view-panel primary-panel">
            <form id="settings-form" class="settings-form" onsubmit="return false;">
              <section class="settings-section">
                <h3>Team identity</h3>
                <label class="field"> <span class="field-label">Team name</span> <input id="settings-teamName" /> </label>
              </section>
              <section class="settings-section">
                <h3>Attendance thresholds</h3>
                <label class="field"> <span class="field-label">Tardy threshold (mins)</span> <input id="settings-tardy" type="number" min="0" step="1" /> </label>
                <fieldset class="fieldset-group">
                  <legend>Legend thresholds</legend>
                  <div class="thresholds compact">
                    <label class="field"> <span class="field-label">Low</span> <input id="settings-low" type="number" min="0" max="1" step="0.01" /> </label>
                    <label class="field"> <span class="field-label">Mid</span> <input id="settings-mid" type="number" min="0" max="1" step="0.01" /> </label>
                    <label class="field"> <span class="field-label">High</span> <input id="settings-high" type="number" min="0" max="1" step="0.01" /> </label>
                  </div>
                </fieldset>
              </section>
              <section class="settings-section">
                <h3>Event types</h3>
                <table class="event-types-table">
                  <thead><tr><th>Label</th><th>Weight</th><th>Actions</th></tr></thead>
                  <tbody id="event-types-tbody"></tbody>
                </table>
                <button id="add-event-type" type="button" class="secondary-action">Add event type</button>
              </section>
              <section class="settings-section">
                <h3>Backup &amp; restore</h3>
                <ol class="backup-flow">
                  <li class="backup-step">
                    <div class="backup-copy">
                      <h4>Step 1 · Save a backup</h4>
                      <p>Download a JSON copy of your roster before making large edits or clearing data.</p>
                    </div>
                    <button id="download-json" type="button" class="secondary-action">Download backup</button>
                  </li>
                  <li class="backup-step">
                    <div class="backup-copy">
                      <h4>Step 2 · Restore a backup</h4>
                      <p>Upload a saved backup to replace the current roster and attendance history.</p>
                    </div>
                    <button id="upload-json-btn" type="button" class="secondary-action">Upload backup</button>
                  </li>
                </ol>
                <div class="backup-restore">
                  <p class="section-note">Need to migrate older data? You can also pull from the original Attendance app.</p>
                  <input id="upload-json-input" type="file" accept="application/json" hidden />
                  <button id="import-v1-btn" type="button" class="secondary-action">Import from v1</button>
                </div>
              </section>
              <section class="settings-section danger-zone">
                <h3>Danger zone</h3>
                <button id="clear-data" class="danger" type="button">Clear all data</button>
              </section>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- Notes modal -->
    <div id="notes-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="notes-title" hidden>
      <div class="modal-content">
        <h2 id="notes-title">Notes</h2>
        <textarea id="notes-text" rows="4" placeholder="Add context" class="modal-text"></textarea>
        <div class="modal-actions">
          <button id="notes-save" type="button" class="primary-action">Save</button>
          <button id="notes-cancel" type="button" class="secondary-action">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Person modal -->
    <div id="person-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="person-modal-title" hidden>
      <div class="modal-content">
        <form id="person-form">
          <h2 id="person-modal-title">Add missionary</h2>
          <label class="field"> <span class="field-label">Full name</span> <input id="person-name" required /> </label>
          <label class="field field-toggle"><input type="checkbox" id="person-active" checked /> <span>Active missionary</span></label>
          <label class="field"> <span class="field-label">Tags</span> <input id="person-tags" placeholder="Comma separated" /> </label>
          <fieldset class="day-selector">
            <legend>Service days</legend>
            <div class="day-grid">
              <label class="field-toggle"><input type="checkbox" data-day="Mon" /> <span>Mon</span></label>
              <label class="field-toggle"><input type="checkbox" data-day="Tue" /> <span>Tue</span></label>
              <label class="field-toggle"><input type="checkbox" data-day="Wed" /> <span>Wed</span></label>
              <label class="field-toggle"><input type="checkbox" data-day="Thu" /> <span>Thu</span></label>
              <label class="field-toggle"><input type="checkbox" data-day="Fri" /> <span>Fri</span></label>
            </div>
          </fieldset>
          <div class="modal-actions">
            <button id="person-save" type="submit" class="primary-action">Save</button>
            <button id="person-cancel" type="button" class="secondary-action">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tardy modal -->
    <div id="tardy-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tardy-title" hidden>
      <div class="modal-content">
        <form id="tardy-form">
          <h2 id="tardy-title">Record tardy</h2>
          <p id="tardy-person" class="modal-subtitle"></p>
          <label class="field"> <span class="field-label">Minutes late</span> <input id="tardy-minutes" type="number" min="0" step="1" required /> </label>
          <div class="modal-actions">
            <button id="tardy-save" type="submit" class="primary-action">Save</button>
            <button id="tardy-cancel" type="button" class="secondary-action">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

    <script>
      // Attach manifest only when served from a secure context (https or localhost)
      (function attachManifest(){
        const isSecure = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
        if (!isSecure) return;
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = 'assets/manifest.webmanifest';
        document.head.appendChild(link);
      })();

      // Register service worker on secure contexts only
      if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('assets/service-worker.js').catch(console.warn);
        });
      }
      // Offline/online badge
      window.addEventListener('online', () => { const b = document.getElementById('offline-badge'); if (b) b.hidden = true; });
      window.addEventListener('offline', () => { const b = document.getElementById('offline-badge'); if (b) b.hidden = false; });
    </script>
  </body>
</html>
